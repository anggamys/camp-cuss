name: Preparation for CI/CD

on:
  workflow_run:
    workflows: ['Build and Publish Docker Image']
    types:
      - completed

jobs:
  preparation:
    name: Preparation Step
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Verify docker-compose.yml exists
        run: |
          echo "Memeriksa file docker-compose.yml..."
          if [ ! -f "be-camp-cuss/docker-compose.yml" ]; then
            echo "File be-camp-cuss/docker-compose.yml tidak ditemukan"
            exit 1
          fi
          echo "File ditemukan: be-camp-cuss/docker-compose.yml"

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "Menguji koneksi SSH ke server..."
            hostname && whoami
            echo "Koneksi SSH berhasil"

      - name: Upload docker-compose.yml to Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'be-camp-cuss/docker-compose.yml'
          target: '$HOME' # hanya direktori, tanpa slash di akhir
          overwrite: true

      - name: Move docker-compose.yml to Deployment Directory
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            FILE_PATH="$HOME/docker-compose.yml"
            DEPLOY_PATH="/opt/be-camp-cuss/docker-compose.yml"

            echo "Memindahkan file docker-compose.yml ke direktori deployment..."
            if [ ! -f "$FILE_PATH" ]; then
              echo "File $FILE_PATH tidak ditemukan setelah upload"
              echo "Isi direktori home untuk debugging:"
              ls -la $HOME
              exit 1
            fi

            sudo mkdir -p /opt/be-camp-cuss
            sudo mv "$FILE_PATH" "$DEPLOY_PATH"
            sudo chown root:root "$DEPLOY_PATH"
            sudo chmod 644 "$DEPLOY_PATH"

            echo "File berhasil dipindahkan ke $DEPLOY_PATH"
