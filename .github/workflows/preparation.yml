name: Preparation for CI/CD

on:
  workflow_run:
    workflows: ['Build and Publish Docker Image']
    types:
      - completed

jobs:
  preparation:
    name: Preparation Step
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # pastikan ambil branch main

      - name: Verify docker-compose.yml exists
        run: |
          if [ ! -f "be-camp-cuss/docker-compose.yml" ]; then
            echo "❌ File be-camp-cuss/docker-compose.yml tidak ditemukan"
            exit 1
          else
            echo "✅ File ditemukan: be-camp-cuss/docker-compose.yml"
          fi

      - name: Upload docker-compose.yml to Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: 'be-camp-cuss/docker-compose.yml'
          target: '~/'

      - name: Move docker-compose.yml to Deployment Directory
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            sudo mkdir -p /opt/be-camp-cuss
            mv ~/docker-compose.yml /opt/be-camp-cuss/docker-compose.yml
            sudo chown root:root /opt/be-camp-cuss/docker-compose.yml
            sudo chmod 644 /opt/be-camp-cuss/docker-compose.yml
