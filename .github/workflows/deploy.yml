name: Deploy Application

on:
  workflow_run:
    workflows:
      - Build and Publish Docker Image
    types:
      - completed

jobs:
  deploy:
    name: Deploy to Production Server
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Log Deployment Start
        run: echo "Starting deployment to production server..."

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/be-camp-cuss
            echo "Login ke GHCR..."
            echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            echo "Menarik image terbaru..."
            if ! sudo docker compose pull; then
              echo "Image belum tersedia, mencoba menarik ulang dengan tag commit..."
              sudo docker compose pull ghcr.io/${{ secrets.GHCR_USERNAME }}/be-camp-cuss:$(sudo docker images --format '{{.Tag}}' | head -n 1) || {
                echo "Gagal menarik image, pastikan image sudah dipublish ke GHCR"
                exit 1
              }
            fi

            echo "Menjalankan ulang container..."
            sudo docker compose up -d --remove-orphans

            echo "Membersihkan resource yang tidak digunakan..."
            sudo docker system prune -af
            echo "Deployment selesai."

      - name: Verify Healthcheck
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            sleep 10
            STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' be-camp-cuss || echo "notfound")
            if [ "$STATUS" != "healthy" ]; then
              echo "Container tidak sehat atau tidak ditemukan. Status: $STATUS"
              sudo docker ps
              exit 1
            fi
            echo "Container dalam kondisi sehat."
